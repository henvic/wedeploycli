# Release process
The release process for the Command-Line Interface tool has a process divided into two major steps: tagging and releasing.

1. A developer tags a new version.
2. From inside the CLI build server, an authorized user continues the release process as described below.

Versions of this tool follow the [Semantic Versioning 2.0](http://www.semver.org/) specification.

Most of the commands below are iterative.

## Tagging
The process of tagging consist of the following steps:

1. Edit `releasenotes.go` and add version information. Commit and push the changes.
2. Add new tag using the command `make tag`.
3. The script asks for the new tag name: use the same name as the version. 

This command runs all code static analysis/quality tools and the unit and integration tests available on the wedeploy/cli package, similarly to `make test`.

Your editor (specified in `$EDITOR` or `core.editor` of git configuration) is open with a tag message you can edit to add more information about the release. By default, the tag message contains a log of changes since the last tagged version.

If everything went OK, a new git tag is created at the end and pushed to origin.

## Building

### Packaging and distribution
`cli` is a Go program, and it compiles to a statically-linked binary file by default. We have to generate a binary for each of our operating systems.

We use [equinox.io](https://equinox.io) to help us build, package, and distribute our self-updating Liferay Cloud client to our costumers.

Two of the most exciting advantages we get by using equinox.io are delta updates (that enhances our consumers updating experience) and package verification (so that our user can trust they are running binaries generated by us). Read [Equinox docs](https://equinox.io/docs) to learn more about how it works.

### Distribution channels
1. stable
2. unstable

Steps to release a new version to the stable channel:

1. tag version (explained above)
2. publish it on the unstable channel
3. run functional tests
4. promote the version to the stable channel
5. run functional tests using the stable channel configuration

If any of the steps above fail, correct what is wrong and try again. Step 5 might be a partial or a slightly modified version of step 3, depending on several factors (such as total time to run the functional tests).

**Notice:** releases are atomic. Packages can't be erased/unpublished.

### Make tag and release notes
1. Fill the release notes in `update/releasenotes/releasenotes.go`.
2. Make tag using the following command `make tag`. The tag will be published on Github.

### Publishing a new version
1. Using the CLI build server

+ Download `equinox.yml`, `equinox.pub` and `equinox.key` (from 1Password) somewhere on your local machine. Verify that  `equinox.yml` is pointing to the right place where `equinox.key` is located and that the `app:` id corresponds to what is written [here](https://github.com/wedeploy/cli/blob/7a00f6d2bfeec5e710f6790b24c1a2a442a6465c/update/keys/keys.go#L9). Do not commit these two files.
+ Download `wedeploy-cli-services.pem` from `CLI Services Builder` section in 1Password
+ Execute the following commands:

```
chmod 600 wedeploy-cli-services.pem
mv wedeploy-cli-services.pem ~/.ssh
ssh -i ~/.ssh/wedeploy-cli-services.pem builder@cli-services.wedeploy.com
```

Afterwards, you are going to be prompted for the password and one-time password. Both can be taken from `CLI Services Builder` section in 1Password.

+ Once connected to the remote machine, navigate to `~/go/src/github.com/wedeploy/cli`.
+ Pull the latest changes from the `master` branch
+ Execute `make release`. It will ask on which channel the release has to be published. First publish on the unstable channel, check the changes, run the functional tests, and then publish on the stable chanel.
+ Execute `make promote` to publish on the stable channel.

2. Using your local machine
+ Install the [equinox release tool](https://dl.equinox.io/equinox/release-tool/stable) for publishing/promoting wedeploy/cli versions.
+ Download `equinox.yml`, `equinox.pub` and `equinox.key` (from 1Password) somewhere on your local machine. Verify that  `equinox.yml` is pointing to the right place where `equinox.key` is located and that the `app:` id corresponds to what is written [here](https://github.com/wedeploy/cli/blob/7a00f6d2bfeec5e710f6790b24c1a2a442a6465c/update/keys/keys.go#L9). Do not commit these files.

The public key is included in the binary file distributed to our users and allows them to seamlessly update their version of CLI.

+ configure it with our public/private key pair. **Keep in mind that keeping these keys safe is essential for protecting our consumer base against arbitrary code execution.**. For that purpose the following ENV variable should be provided:

```shell
WEDEPLOY_CLI_RELEASE_CONFIG_PATH=<path-to>/equinox.yml make release
```

It will ask on which channel the release has to be published. First publish on the unstable channel, check the changes, run the functional tests, and then publish on the stable chanel.

+ Execute `make promote` to publish on the stable channel.

This command builds the static binaries necessary for all supported operating systems and uploads them to Equinox.

For this command to work, you have to be at the HEAD of the version (tag) you choose to publish.

You always release first to the unstable channel, then promote the new version to the stable channel. If you try to use this make command for publishing to the stable channel directly, a failure happens.

### Run functional tests
All functional tests must now be run and verified before going to the next step.

Copy `settings-sample.tcl` to `settings.tcl` and configure it.

```shell
make functional-tests
```

### Promoting to the stable channel
If all functional tests passed, a release should be ready for being promoted to the stable channel using the `make promote` command.

### Run functional tests against the stable channel
Verify if updating from previous CLI version works fine and that it is returning the same new binary file tested on the unstable channel.

## CLI build server access
Access to the CLI build server is restricted for security reasons on an as-needed basis. All users of it are required to meet certain security criteria.

If you require access to it, request an account with the CLI team by explaining why you need to and provide an SSH public key (and consider having your private key protected by password) over secure means.

* You MUST keep your private key in a safe place
* You MUST NOT share your private access keys with others
* You MUST use your own credentials for accessing the build server
* You MUST take care about what kind of software you run on your computer and their sources (e.g., npm packages are a high risk)
* You SHOULD NOT export sensitive data such as private keys from the build server to your machine

Failure in following any of these security guidelines would jeopardize our consumer computers.

Besides security, an additional benefit from using the build server instead of doing the release from your own machine is that this way we have a more consistent build setup, greater performance (building and uploading the binaries are usually faster than from a home computer or lousy Internet connection).

### Equinox configuration
Builds must be generated for the following platforms:

* macOS (amd64, i386)
* Linux (amd64, i386, arm)
* Windows (amd64, 386)
* FreeBSD (amd64, 386, arm)
* NetBSD (amd64, 386, arm)

Builds for other platforms might be generated as well.

Equinox uses a token and a public/private key pair. A token authenticates and authorizes the release tool to upload builds to your account. The public/private key pair allows us to sign our code and permit seamlessly update for our users.

Besides digital backup, the private key is printed and safely stored in a physical vault. A new token can be generated on the Equinox console if needed.

On [equinox.io](https://equinox.io) you can find the app ID.
